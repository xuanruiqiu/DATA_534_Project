---
title: "Introduction to rGoldETF"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction to rGoldETF}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(

  collapse = TRUE,
  comment = "#>",
  fig.width = 7,
  fig.height = 5,
  eval = FALSE
)
```

## Overview

The `rGoldETF` package provides a comprehensive R interface to the [Twelve Data API](https://twelvedata.com/) for fetching, analyzing, and visualizing Gold ETF (GLD) data. This vignette demonstrates the complete workflow from setup to visualization.

## Installation

You can install rGoldETF from GitHub:

```{r installation}
# install.packages("devtools")
devtools::install_github("xuanruiqiu/DATA_534_Project", subdir = "rGoldETF")
```

## Setup: API Key Configuration

Before using the package, you need to obtain a free API key from [Twelve Data](https://twelvedata.com/pricing).

```{r setup}
library(rGoldETF)

# Method 1: Set environment variable (recommended)
Sys.setenv(TWELVE_DATA_API_KEY = "your_api_key_here")

# Method 2: Use the package helper function
gld_set_api_key("your_api_key_here")
```

**Note:** The free tier allows 8 API calls per minute. The examples below include delays to respect rate limits.

## Getting Real-Time Prices

### GLD ETF Price

The `get_gld_price()` function retrieves the current price of the GLD ETF:
```{r gld-price}
# Get current GLD price
gld_price <- get_gld_price()
print(gld_price)
```

Example output:
```
$symbol
[1] "GLD"

$name
[1] "SPDR Gold Shares"

$price
[1] 185.50

$change
[1] 1.25

$change_percent
[1] 0.68

$volume
[1] 5000000

$timestamp
[
1] "2024-01-15 16:00:00 EST"
```

### Gold Spot Price (XAU/USD)

```{r gold-spot}
# Get gold spot price
gold_spot <- get_gold_spot_price()
print(gold_spot)
```

### Other ETF Prices

```{r other-etf}
# Get price for any ETF
iau_price <- get_etf_price("IAU")  # iShares Gold Trust
print(iau_price)
```

## Historical Data

### GLD Historical Data

The `get_gld_history()` function retrieves historical price data:

```{r gld-history}
# Get last 30 days of GLD data
gld_history <- get_gld_history(
  start_date = Sys.Date() - 30,
  end_date = Sys.Date()
)
head(gld_history)
```

Example output:
```
        date   open   high    low  close   volume
1 2024-01-02 180.50 182.00 179.75 181.25  5000000
2 2024-01-03 181.25 183.00 180.50 182.75  4800000
3 2024-01-04 182.75 184.25 181.00 183.50  5200000
4 2024-01-05 183.50 185.00 182.25 184.00  4900000
5 2024-01-08 184.00 185.50 183.00 185.25  5100000
6 2024-01-09 185.25 186.00 184.50 185.75  4700000
```

### Different Intervals

```{r intervals}
# Weekly data
gld_weekly <- get_gld_history(
  start_date = "2023-01-01",
  end_date = "2023-12-31",
  interval = "1week"
)

# Monthly data
gld_monthly <- get_gld_history(
  start_date = "2022-01-01",
  end_date = "2023-12-31",
  interval = "1month"
)
```

### Gold Spot Historical Data

```{r gold-spot-history}
# Get gold spot price history
gold_history <- get_gold_spot_history(
  start_date = "2024-01-01",
  end_date = "2024-01-31"
)
head(gold_history)
```

## Technical Indicators

The `get_technical_indicators()` function calculates various technical indicators locally (no additional API calls required):

### Simple Moving Average (SMA) and Exponential Moving Average (EMA)

```{r sma-ema}
# Get historical data first
history_data <- get_gld_history(
  start_date = Sys.Date() - 90,
  end_date = Sys.Date()
)

# Calculate SMA and EMA
data_with_ma <- get_technical_indicators(
  history_data,
  indicators = c("sma", "ema"),
  periods = list(sma = 20, ema = 12)
)

# View results
tail(data_with_ma[, c("date", "close", "sma", "ema")], 10)
```

### Relative Strength Index (RSI)

```{r rsi}
# Calculate RSI
data_with_rsi <- get_technical_indicators(
  history_data,
  indicators = "rsi",
  periods = list(rsi = 14)
)

# View RSI values
tail(data_with_rsi[, c("date", "close", "rsi")], 10)
```

### MACD (Moving Average Convergence Divergence)

```{r macd}
# Calculate MACD
data_with_macd <- get_technical_indicators(
  history_data,
  indicators = "macd"
)

# View MACD components
tail(data_with_macd[, c("date", "macd", "macd_signal", "macd_histogram")], 10)
```

### Bollinger Bands

```{r bollinger}
# Calculate Bollinger Bands
data_with_bb <- get_technical_indicators(
  history_data,
  indicators = "bollinger",
  periods = list(sma = 20)
)

# View Bollinger Bands
tail(data_with_bb[, c("date", "close", "bb_upper", "bb_middle", "bb_lower")], 10)
```

### All Indicators Combined

```{r all-indicators}
# Calculate all indicators at once
data_full <- get_technical_indicators(
  history_data,
  indicators = c("sma", "ema", "rsi", "macd", "bollinger"),
  periods = list(sma = 20, ema = 12, rsi = 14)
)
```

## Visualization

The `plot_gld_chart()` function creates professional charts using ggplot2.

### Basic Line Chart

```{r plot-line, eval=TRUE, echo=TRUE}
# Create sample data for demonstration
set.seed(42)
n <- 60
demo_data <- data.frame(
  date = seq(Sys.Date() - n + 1, Sys.Date(), by = "day"),
  open = cumsum(rnorm(n, 0.1, 1)) + 180,
  high = cumsum(rnorm(n, 0.15, 1)) + 182,
  low = cumsum(rnorm(n, 0.05, 1)) + 178,
  close = cumsum(rnorm(n, 0.1, 1)) + 180,
  volume = abs(rnorm(n, 5000000, 1000000))
)
demo_data$high <- pmax(demo_data$high, demo_data$open, demo_data$close)
demo_data$low <- pmin(demo_data$low, demo_data$open, demo_data$close)

library(ggplot2)

# Basic line chart
p1 <- ggplot(demo_data, aes(x = date, y = close)) +
  geom_line(color = "steelblue", linewidth = 0.8) +
  labs(title = "GLD Price Chart", x = "Date", y = "Price (USD)") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))
print(p1)
```

### Chart with Moving Averages

```{r plot-ma, eval=TRUE, echo=TRUE}
# Add moving averages to demo data
demo_data$sma <- stats::filter(demo_data$close, rep(1/20, 20), sides = 1)
alpha <- 2 / (12 + 1)
demo_data$ema <- demo_data$close[1]
for (i in 2:nrow(demo_data)) {
  demo_data$ema[i] <- alpha * demo_data$close[i] + (1 - alpha) * demo_data$ema[i-1]
}

# Chart with indicators
p2 <- ggplot(demo_data, aes(x = date)) +
  geom_line(aes(y = close), color = "steelblue", linewidth = 0.8) +
  geom_line(aes(y = sma), color = "orange", linewidth = 0.6, na.rm = TRUE) +
  geom_line(aes(y = ema), color = "purple", linewidth = 0.6, na.rm = TRUE) +
  labs(
    title = "GLD with Moving Averages",
    subtitle = "Orange: 20-day SMA, Purple: 12-day EMA",
    x = "Date",
    y = "Price (USD)"
  ) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))
print(p2)
```

### Candlestick Chart

```{r plot-candlestick, eval=TRUE, echo=TRUE}
# Candlestick chart (last 30 days for clarity)
candle_data <- tail(demo_data, 30)
candle_data$direction <- ifelse(candle_data$close >= candle_data$open, "up", "down")

p3 <- ggplot(candle_data, aes(x = date)) +
  geom_segment(aes(xend = date, y = low, yend = high), color = "black") +
  geom_rect(aes(
    xmin = date - 0.3,
    xmax = date + 0.3,
    ymin = pmin(open, close),
    ymax = pmax(open, close),
    fill = direction
  )) +
  scale_fill_manual(values = c("up" = "green", "down" = "red"), guide = "none") +
  labs(title = "GLD Candlestick Chart", x = "Date", y = "Price (USD)") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))
print(p3)
```

### Chart with Bollinger Bands

```{r plot-bollinger, eval=TRUE, echo=TRUE}
# Add Bollinger Bands
demo_data$bb_middle <- demo_data$sma
sd_val <- sd(demo_data$close, na.rm = TRUE)
demo_data$bb_upper <- demo_data$bb_middle + 2 * sd_val
demo_data$bb_lower <- demo_data$bb_middle - 2 * sd_val

p4 <- ggplot(demo_data, aes(x = date)) +
  geom_ribbon(aes(ymin = bb_lower, ymax = bb_upper),
              fill = "lightblue", alpha = 0.3, na.rm = TRUE) +
  geom_line(aes(y = close), color = "steelblue", linewidth = 0.8) +
  geom_line(aes(y = bb_middle), color = "orange", linetype = "dashed", na.rm = TRUE) +
  geom_line(aes(y = bb_upper), color = "gray50", linetype = "dashed", na.rm = TRUE) +
  geom_line(aes(y = bb_lower), color = "gray50", linetype = "dashed", na.rm = TRUE) +
  labs(
    title = "GLD with Bollinger Bands",
    subtitle = "20-day SMA with 2 standard deviation bands",
    x = "Date",
    y = "Price (USD)"
  ) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))
print(p4)
```

## Comparing Multiple Gold ETFs

The `compare_gold_etfs()` function allows you to compare multiple gold-related ETFs:

```{r compare-etfs}
# Compare GLD, IAU, and SGOL
comparison <- compare_gold_etfs(
  symbols = c("GLD", "IAU", "SGOL"),
  start_date = Sys.Date() - 30,
  end_date = Sys.Date(),
  delay = 8  # Respect API rate limits
)
head(comparison, 15)
```

### Visualizing ETF Comparison

```{r plot-comparison, eval=TRUE, echo=TRUE}
# Create sample comparison data
set.seed(123)
dates <- seq(Sys.Date() - 29, Sys.Date(), by = "day")
comparison_demo <- data.frame(
  date = rep(dates, 3),
  symbol = rep(c("GLD", "IAU", "SGOL"), each = 30),
  normalized = c(
    100 + cumsum(rnorm(30, 0.1, 0.5)),
    100 + cumsum(rnorm(30, 0.08, 0.45)),
    100 + cumsum(rnorm(30, 0.12, 0.55))
  )
)

p5 <- ggplot(comparison_demo, aes(x = date, y = normalized, color = symbol)) +
  geom_line(linewidth = 1) +
  scale_color_manual(values = c("GLD" = "gold", "IAU" = "steelblue", "SGOL" = "darkgreen")) +
  labs(
    title = "Gold ETF Comparison",
    subtitle = "Normalized to 100 at start date",
    x = "Date",
    y = "Normalized Price",
    color = "ETF"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    legend.position = "bottom"
  )
print(p5)
```

### Comparing Gold vs Bitcoin

The `plot_asset_comparison()` function creates a normalized price comparison chart for Gold (XAU/USD) and Bitcoin (BTC/USD):

```{r plot-asset-comparison}
# Compare Gold vs Bitcoin for the last 30 days
plot_asset_comparison(
  start_date = Sys.Date() - 30,
  end_date = Sys.Date()
)

# Weekly comparison
plot_asset_comparison(
  start_date = "2024-01-01",
  end_date = "2024-06-30",
  interval = "1week"
)
```

```{r plot-asset-comparison-demo, eval=TRUE, echo=TRUE}
# Create sample comparison data for Gold vs Bitcoin
set.seed(456)
dates <- seq(Sys.Date() - 29, Sys.Date(), by = "day")
asset_comparison_demo <- data.frame(
  date = rep(dates, 2),
  symbol = rep(c("XAU/USD", "BTC/USD"), each = 30),
  normalized = c(
    100 + cumsum(rnorm(30, 0.05, 0.3)),
    100 + cumsum(rnorm(30, 0.1, 1.5))
  )
)

p6 <- ggplot(asset_comparison_demo, aes(x = date, y = normalized, color = symbol)) +
  geom_line(linewidth = 0.8) +
  scale_color_manual(
    values = c("XAU/USD" = "gold3", "BTC/USD" = "orange"),
    labels = c("XAU/USD" = "Gold", "BTC/USD" = "Bitcoin")
  ) +
  labs(
    title = "Gold vs Bitcoin - Normalized Price Comparison",
    x = "Date",
    y = "Normalized Price (Start = 100)",
    color = "Asset"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "bottom"
  )
print(p6)
```

## Additional Functions

### Search for Gold-Related Symbols

```{r search}
# Search for gold-related symbols
gold_symbols <- search_gold_symbols("gold")
head(gold_symbols, 10)
```

### Check Market State

```{r market-state}
# Check if NYSE is open
market_state <- get_market_state("NYSE")
print(market_state)
```

## Complete Analysis Example

Here's a complete workflow combining all the features:

```{r complete-analysis}
# 1. Get current price
current <- get_gld_price()
cat("Current GLD Price:", current$price, "\n")
cat("Today's Change:", current$change, "(", current$change_percent, "%)\n\n")

Sys.sleep(8)  # Respect rate limits

# 2. Get historical data
history <- get_gld_history(
  start_date = Sys.Date() - 60,
  end_date = Sys.Date()
)

# 3. Calculate technical indicators (no API call)
analysis_data <- get_technical_indicators(
  history,
  indicators = c("sma", "ema", "rsi", "macd", "bollinger")
)

# 4. Get latest values
latest <- tail(analysis_data, 1)

cat("Technical Analysis Summary:\n")
cat("- 20-day SMA:", round(latest$sma, 2), "\n")
cat("- 12-day EMA:", round(latest$ema, 2), "\n")
cat("- RSI(14):", round(latest$rsi, 2), "\n")
cat("- MACD:", round(latest$macd, 4), "\n")

# 5. Generate signals
cat("\nSignal Analysis:\n")
if (latest$close > latest$sma) {
  cat("- Price above SMA: BULLISH\n")
} else {
  cat("- Price below SMA: BEARISH\n")
}

if (latest$rsi > 70) {
  cat("- RSI > 70: OVERBOUGHT\n")
} else if (latest$rsi < 30) {
  cat("- RSI < 30: OVERSOLD\n")
} else {
  cat("- RSI in neutral zone\n")
}

# 6. Create visualization
chart <- plot_gld_chart(
  analysis_data,
  type = "line",
  indicators = c("sma", "ema"),
  title = paste("GLD Analysis -", Sys.Date())
)
print(chart)
```

## API Rate Limiting

The free tier of Twelve Data API allows 8 requests per minute. To avoid hitting rate limits:

1. Use the `delay` parameter in `compare_gold_etfs()`
2. Add `Sys.sleep(8)` between API calls in your scripts
3. Technical indicator calculations are done locally and don't require API calls

## Error Handling

The package handles errors gracefully:

```{r error-handling}
# Missing API key
tryCatch({
  Sys.setenv(TWELVE_DATA_API_KEY = "")
  get_gld_price()
}, error = function(e) {
  cat("Error:", e$message, "\n")
})

# Invalid date range
tryCatch({
  get_gld_history(
    start_date = "2024-01-31",
    end_date = "2024-01-01"  # End before start
  )
}, error = function(e) {
  cat("Error:", e$message, "\n")
})
```

## Session Info

```{r session-info, eval=TRUE}
sessionInfo()
```
