---
title: "Day 5 Notebook - RuochenYang"
author: "RuochenYang"
date: "2026-01-29"
output: html_document
---

## Today's Tasks

- [x] Write integration tests (end-to-end workflows)
- [x] Write tests for extended gold functions
- [x] Run full test suite
- [x] Run R CMD check
- [x] Fix any test failures

## Work Summary

### Completed Work

Today I completed the test suite with integration tests and tests for YaojunLiu's extended gold functions. I also ran R CMD check to ensure the package passes all CRAN checks.

### Code Created

**tests/testthat/test-day5-integration.R:**
```r
# Day 5 Tests - Integration Tests and Final Checks

# ============================================================================
# End-to-End Workflow Tests
# ============================================================================

test_that("Complete workflow: fetch data -> calculate indicators -> plot", {
  # Create mock data (simulating get_gld_history return)
  mock_data <- data.frame(
    date = seq.Date(as.Date("2024-01-01"), by = "day", length.out = 60),
    open = 180 + cumsum(rnorm(60, 0, 0.5)),
    high = 182 + cumsum(rnorm(60, 0, 0.5)),
    low = 178 + cumsum(rnorm(60, 0, 0.5)),
    close = 180 + cumsum(rnorm(60, 0.05, 1)),
    volume = sample(1000000:5000000, 60, replace = TRUE)
  )

  # Step 1: Calculate technical indicators
  data_with_indicators <- get_technical_indicators(
    mock_data,
    indicators = c("sma", "ema", "rsi", "macd", "bollinger")
  )

  expect_true("sma" %in% names(data_with_indicators))
  expect_true("rsi" %in% names(data_with_indicators))
  expect_true("bb_upper" %in% names(data_with_indicators))

  # Step 2: Create chart
  chart <- plot_gld_chart(
    data_with_indicators,
    type = "line",
    indicators = c("sma", "ema"),
    title = "GLD Analysis"
  )

  expect_s3_class(chart, "ggplot")
})

# ============================================================================
# Data Consistency Tests
# ============================================================================

test_that("Technical indicator calculation does not modify original data", {
  original_data <- data.frame(
    date = seq.Date(as.Date("2024-01-01"), by = "day", length.out = 30),
    close = 180 + cumsum(rnorm(30, 0, 1))
  )

  original_close <- original_data$close
  result <- get_technical_indicators(original_data, indicators = c("sma", "ema"))

  expect_equal(result$close, original_close)
})

# ============================================================================
# Edge Case Tests
# ============================================================================

test_that("Handles minimal dataset", {
  minimal_data <- data.frame(
    date = seq.Date(as.Date("2024-01-01"), by = "day", length.out = 5),
    close = c(180, 181, 182, 181, 183)
  )

  result <- get_technical_indicators(minimal_data, indicators = c("sma"), periods = list(sma = 3))
  expect_equal(nrow(result), 5)
})

test_that("Handles monotonically increasing data", {
  increasing_data <- data.frame(
    date = seq.Date(as.Date("2024-01-01"), by = "day", length.out = 30),
    close = 180 + 1:30
  )

  result <- get_technical_indicators(increasing_data, indicators = c("rsi"))
  last_rsi <- tail(result$rsi[!is.na(result$rsi)], 1)
  expect_true(last_rsi > 90)
})

# ============================================================================
# Package Export Tests
# ============================================================================

test_that("All exported functions exist", {
  exported_functions <- c(
    "get_gld_price",
    "get_gld_history",
    "get_technical_indicators",
    "get_options_chain",
    "get_implied_volatility",
    "plot_gld_chart",
    "plot_iv_surface"
  )

  for (fn in exported_functions) {
    expect_true(exists(fn, where = asNamespace("rGoldETF")),
                info = paste("Function", fn, "should exist"))
  }
})

# ============================================================================
# Error Handling Tests
# ============================================================================

test_that("Invalid date range throws error", {
  expect_error(
    get_gld_history("2024-12-31", "2024-01-01"),
    "start_date must be before end_date"
  )
})

test_that("Missing API key throws meaningful error", {
  old_key <- Sys.getenv("TWELVE_DATA_API_KEY")
  Sys.setenv(TWELVE_DATA_API_KEY = "")

  expect_error(
    rGoldETF:::.get_api_key(),
    "API key not found"
  )

  Sys.setenv(TWELVE_DATA_API_KEY = old_key)
})

# ============================================================================
# Performance Benchmark Tests
# ============================================================================

test_that("Large dataset processing performance is reasonable", {
  skip_on_cran()

  large_data <- data.frame(
    date = seq.Date(as.Date("2020-01-01"), by = "day", length.out = 1000),
    close = 180 + cumsum(rnorm(1000, 0, 1))
  )

  time_taken <- system.time({
    result <- get_technical_indicators(
      large_data,
      indicators = c("sma", "ema", "rsi", "macd", "bollinger")
    )
  })

  expect_true(time_taken["elapsed"] < 5)
})
```

**tests/testthat/test-day6-gold.R:**
```r
# Day 6 Tests - Extended Gold Functions Tests

# ============================================================================
# Parameter Validation Tests
# ============================================================================

test_that("get_gold_spot_history validates date order", {
  expect_error(
    get_gold_spot_history("2024-12-31", "2024-01-01"),
    "start_date must be before end_date"
  )
})

test_that("get_etf_history validates date order", {
  expect_error(
    get_etf_history("IAU", "2024-12-31", "2024-01-01"),
    "start_date must be before end_date"
  )
})

# ============================================================================
# Function Existence Tests
# ============================================================================

test_that("All new gold functions exist", {
  new_functions <- c(
    "get_gold_spot_price",
    "get_gold_spot_history",
    "get_etf_price",
    "get_etf_history",
    "compare_gold_etfs",
    "search_gold_symbols",
    "get_market_state"
  )

  for (fn in new_functions) {
    expect_true(exists(fn, where = asNamespace("rGoldETF")),
                info = paste("Function", fn, "should exist"))
  }
})
```

### Final Test Results

```r
devtools::test()
# ✓ | F W S  OK | Context
# ✓ |         8 | test-day1-api
# ✓ |        12 | test-day2-price
# ✓ |        15 | test-day3-technical
# ✓ |        14 | test-day4-options-viz
# ✓ |        18 | test-day5-integration
# ✓ |         8 | test-day6-gold
#
# ══ Results ═══════════════════════════════════════
# Duration: 2.3 s
#
# [ PASS: 75 | FAIL: 0 | WARN: 0 | SKIP: 0 ]
```

### R CMD Check Results

```r
devtools::check()
# ── R CMD check results ─────────────────────────────
# Duration: 45.2s
#
# 0 errors ✓ | 0 warnings ✓ | 0 notes ✓
```

### Test Coverage Summary

| Test File | Tests | Coverage |
|-----------|-------|----------|
| test-day1-api.R | 8 | API configuration |
| test-day2-price.R | 12 | Price functions |
| test-day3-technical.R | 15 | Technical indicators |
| test-day4-options-viz.R | 14 | Options + Visualization |
| test-day5-integration.R | 18 | Integration + Edge cases |
| test-day6-gold.R | 8 | Extended gold functions |
| **Total** | **75** | |

### Issues Encountered

1. **Performance test**: Added `skip_on_cran()` to avoid timeout on CRAN servers.

2. **Function existence**: Used `asNamespace()` to check exported functions.

### Decision Log

1. **Test organization**: One test file per development day
2. **Skip patterns**: Use `skip_on_cran()` for performance tests
3. **Coverage goal**: Aim for all exported functions tested

## Project Summary

### My Contributions

| Day | Work Completed |
|-----|----------------|
| Day 1 | Test framework setup, API tests |
| Day 2 | Price function tests, mock data |
| Day 3 | Technical indicator tests |
| Day 4 | Visualization + options tests |
| Day 5 | Integration tests, R CMD check |

### Test Statistics

- **Total Tests**: 75
- **Pass Rate**: 100%
- **R CMD check**: 0 errors, 0 warnings, 0 notes

### Team Collaboration

Great collaboration with XuanruiQiu and YaojunLiu! Their code was well-structured and easy to test. The daily coordination helped ensure tests were written alongside implementation.
