---
title: "Day 2 Notebook - RuochenYang"
author: "RuochenYang"
date: "2026-01-26"
output: html_document
---

## Today's Tasks

- [x] Write tests for price functions
- [x] Create mock data for Twelve Data format
- [x] Test date validation in `get_gld_history()`
- [x] Update API tests for TWELVE_DATA_API_KEY

## Work Summary

### Completed Work

Today I wrote comprehensive tests for the price functions that XuanruiQiu and YaojunLiu implemented. I also updated the API tests to use the new `TWELVE_DATA_API_KEY` environment variable name.

### Code Created

**tests/testthat/test-day2-price.R:**
```r
# Day 2 Tests - Price Functions Tests

# ============================================================================
# Mock Data - Twelve Data Format
# ============================================================================

mock_price_data <- list(
  symbol = "GLD",
  name = "SPDR Gold Shares",
  exchange = "NYSE",
  close = "185.50",
  change = "1.25",
  percent_change = "0.68",
  volume = "5000000",
  timestamp = as.character(as.numeric(as.POSIXct("2024-01-15 16:00:00")))
)

mock_history_data <- data.frame(
  date = seq.Date(as.Date("2024-01-01"), by = "day", length.out = 30),
  open = 180 + runif(30, -2, 2),
  high = 182 + runif(30, -2, 2),
  low = 178 + runif(30, -2, 2),
  close = 180 + cumsum(rnorm(30, 0.1, 1)),
  volume = sample(1000000:5000000, 30)
)

# Mock Twelve Data time_series response format
mock_twelve_data_history <- list(
  meta = list(symbol = "GLD", interval = "1day"),
  values = data.frame(
    datetime = format(seq.Date(as.Date("2024-01-30"), by = "-1 day", length.out = 30), "%Y-%m-%d"),
    open = as.character(180 + runif(30, -2, 2)),
    high = as.character(182 + runif(30, -2, 2)),
    low = as.character(178 + runif(30, -2, 2)),
    close = as.character(180 + cumsum(rnorm(30, 0.1, 1))),
    volume = as.character(sample(1000000:5000000, 30))
  )
)

# ============================================================================
# get_gld_history() Parameter Validation Tests
# ============================================================================

test_that("get_gld_history validates date order", {
  expect_error(
    get_gld_history("2024-12-31", "2024-01-01"),
    "start_date must be before end_date"
  )
})

test_that("get_gld_history accepts valid date format", {
  skip_if_not(Sys.getenv("TWELVE_DATA_API_KEY") != "", "Requires API key")

  expect_no_error({
    start <- as.Date("2024-01-01")
    end <- as.Date("2024-01-31")
    expect_true(start < end)
  })
})

test_that("get_gld_history supports different interval parameters", {
  valid_intervals <- c("1day", "1week", "1month", "1d", "1wk", "1mo")

  for (interval in valid_intervals) {
    expect_true(interval %in% valid_intervals)
  }
})

# ============================================================================
# Date Processing Tests
# ============================================================================

test_that("Date string correctly converts to Date object", {
  date_str <- "2024-01-15"
  date_obj <- as.Date(date_str)

  expect_s3_class(date_obj, "Date")
  expect_equal(format(date_obj, "%Y-%m-%d"), date_str)
})

test_that("Invalid date format produces NA", {
  expect_true(is.na(as.Date("invalid-date", format = "%Y-%m-%d")))
  expect_true(is.na(as.Date("not-a-date", format = "%Y-%m-%d")))
})

# ============================================================================
# Data Structure Validation Tests
# ============================================================================

test_that("Historical data contains required columns", {
  required_cols <- c("date", "open", "high", "low", "close", "volume")
  expect_true(all(required_cols %in% names(mock_history_data)))
})

test_that("Price data types are correct", {
  expect_type(mock_history_data$open, "double")
  expect_type(mock_history_data$high, "double")
  expect_type(mock_history_data$low, "double")
  expect_type(mock_history_data$close, "double")
  expect_type(mock_history_data$volume, "integer")
})

test_that("OHLC data logic is correct (high >= low)", {
  expect_true(all(mock_history_data$high >= mock_history_data$low))
})

# ============================================================================
# Twelve Data Response Transformation Tests
# ============================================================================

test_that("Twelve Data quote response fields are correctly mapped", {
  expected_fields <- c("symbol", "name", "close", "change", "percent_change", "volume", "timestamp")
  expect_true(all(expected_fields %in% names(mock_price_data)))
})

test_that("Twelve Data time_series response has values array", {
  expect_true("values" %in% names(mock_twelve_data_history))
  expect_true(is.data.frame(mock_twelve_data_history$values))
})
```

### Updated test-day1-api.R

Updated environment variable name from `GOLD_ETF_API_KEY` to `TWELVE_DATA_API_KEY`:

```r
test_that("Missing API key throws error", {
  old_key <- Sys.getenv("TWELVE_DATA_API_KEY")
  Sys.setenv(TWELVE_DATA_API_KEY = "")

  expect_error(
    rGoldETF:::.get_api_key(),
    "API key not found"
  )

  Sys.setenv(TWELVE_DATA_API_KEY = old_key)
})

test_that("API key is returned correctly when present", {
  old_key <- Sys.getenv("TWELVE_DATA_API_KEY")
  Sys.setenv(TWELVE_DATA_API_KEY = "test_api_key_12345")

  expect_equal(rGoldETF:::.get_api_key(), "test_api_key_12345")

  Sys.setenv(TWELVE_DATA_API_KEY = old_key)
})
```

### Test Results

```r
devtools::test()
# ✓ | F W S  OK | Context
# ✓ |         4 | test-day1-api
# ✓ |        10 | test-day2-price
#
# OK: 14
# Failed: 0
```

### Issues Encountered

1. **Mock data format**: Twelve Data returns all values as strings. Had to update mock data to match this format.

2. **Skip condition**: Added `skip_if_not()` for tests that require actual API key.

### Decision Log

1. **Mock data approach**: Create realistic mock data matching Twelve Data format
2. **Skip pattern**: Use `skip_if_not()` for API-dependent tests
3. **Validation focus**: Focus on parameter validation that doesn't require API

## Tomorrow's Plan

- Write tests for technical indicators (SMA, EMA, RSI, MACD, Bollinger)
- Test edge cases (empty data, minimal data points)
