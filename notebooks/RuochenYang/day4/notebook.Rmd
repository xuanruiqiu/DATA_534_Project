---
title: "Day 4 Notebook - RuochenYang"
author: "RuochenYang"
date: "2026-01-28"
output: html_document
---

## Today's Tasks

- [x] Write tests for visualization functions
- [x] Write tests for options functions (paid feature error handling)
- [x] Test `plot_gld_chart()` returns ggplot object
- [x] Test `plot_iv_surface()` returns ggplot object
- [x] Test chart customization options

## Work Summary

### Completed Work

Today I wrote tests for the visualization functions (XuanruiQiu's work) and the options functions (which now return errors since they require paid subscription).

### Code Created

**tests/testthat/test-day4-options-viz.R:**
```r
# Day 4 Tests - Options and Visualization Tests

# ============================================================================
# Mock Data
# ============================================================================

# Price history mock data
mock_price_history <- data.frame(
  date = seq.Date(as.Date("2024-01-01"), by = "day", length.out = 60),
  open = 180 + cumsum(rnorm(60, 0, 0.5)),
  high = 182 + cumsum(rnorm(60, 0, 0.5)),
  low = 178 + cumsum(rnorm(60, 0, 0.5)),
  close = 180 + cumsum(rnorm(60, 0.05, 1)),
  volume = sample(1000000:5000000, 60, replace = TRUE)
)

# Implied volatility mock data (for visualization testing only)
mock_iv_data <- data.frame(
  strike = rep(seq(170, 200, by = 5), 4),
  expiration = rep(c("2024-02-16", "2024-03-15", "2024-04-19", "2024-06-21"), each = 7),
  call_iv = runif(28, 0.12, 0.30),
  put_iv = runif(28, 0.12, 0.30),
  days_to_expiry = rep(c(30, 60, 90, 150), each = 7)
)

# ============================================================================
# Options Functions Tests (Paid Feature)
# ============================================================================

test_that("get_options_chain returns error for free tier", {
  expect_error(
    get_options_chain("GLD"),
    "paid Twelve Data subscription"
  )
})

test_that("get_implied_volatility returns error for free tier", {
  expect_error(
    get_implied_volatility("GLD"),
    "paid Twelve Data subscription"
  )
})

# ============================================================================
# Visualization Tests - plot_gld_chart()
# ============================================================================

test_that("plot_gld_chart returns ggplot object", {
  p <- plot_gld_chart(mock_price_history)
  expect_s3_class(p, "ggplot")
})

test_that("plot_gld_chart supports line type", {
  p <- plot_gld_chart(mock_price_history, type = "line")
  expect_s3_class(p, "ggplot")
})

test_that("plot_gld_chart supports candlestick type", {
  p <- plot_gld_chart(mock_price_history, type = "candlestick")
  expect_s3_class(p, "ggplot")
})

test_that("plot_gld_chart can add indicators", {
  data_with_indicators <- get_technical_indicators(
    mock_price_history,
    indicators = c("sma", "ema")
  )

  p <- plot_gld_chart(
    data_with_indicators,
    type = "line",
    indicators = c("sma", "ema")
  )

  expect_s3_class(p, "ggplot")
})

test_that("plot_gld_chart custom title", {
  custom_title <- "My Custom Chart"
  p <- plot_gld_chart(mock_price_history, title = custom_title)

  expect_equal(p$labels$title, custom_title)
})

# ============================================================================
# Visualization Tests - plot_iv_surface()
# ============================================================================

test_that("plot_iv_surface returns ggplot object", {
  p <- plot_iv_surface(mock_iv_data)
  expect_s3_class(p, "ggplot")
})

test_that("plot_iv_surface supports call type", {
  p <- plot_iv_surface(mock_iv_data, option_type = "call")
  expect_s3_class(p, "ggplot")
})

test_that("plot_iv_surface supports put type", {
  p <- plot_iv_surface(mock_iv_data, option_type = "put")
  expect_s3_class(p, "ggplot")
})

test_that("plot_iv_surface custom title", {
  custom_title <- "Custom IV Surface"
  p <- plot_iv_surface(mock_iv_data, title = custom_title)

  expect_equal(p$labels$title, custom_title)
})

# ============================================================================
# Chart Element Tests
# ============================================================================

test_that("Price chart has correct axis labels", {
  p <- plot_gld_chart(mock_price_history)

  expect_equal(p$labels$x, "Date")
  expect_equal(p$labels$y, "Price (USD)")
})

test_that("IV chart has correct axis labels", {
  p <- plot_iv_surface(mock_iv_data)

  expect_equal(p$labels$x, "Strike Price")
  expect_equal(p$labels$y, "Days to Expiration")
})
```

### Test Results

```r
devtools::test()
# ✓ | F W S  OK | Context
# ✓ |         4 | test-day1-api
# ✓ |        10 | test-day2-price
# ✓ |        15 | test-day3-technical
# ✓ |        14 | test-day4-options-viz
#
# OK: 43
# Failed: 0
```

### Visualization Test Strategy

| Function | Test Aspects |
|----------|--------------|
| `plot_gld_chart()` | Return type, chart types, indicators, title |
| `plot_iv_surface()` | Return type, option types, title |

### Issues Encountered

1. **ggplot object testing**: Used `expect_s3_class(p, "ggplot")` to verify return type.

2. **Title extraction**: Accessed title via `p$labels$title` for verification.

3. **Options error testing**: Used `expect_error()` with partial message match.

### Decision Log

1. **Mock IV data**: Created mock IV data for visualization testing even though options API is paid
2. **Chart type coverage**: Test both line and candlestick chart types
3. **Label verification**: Verify axis labels are set correctly

## Tomorrow's Plan

- Write comprehensive integration tests
- Run full test suite
- Help with R CMD check
- Write test for extended gold functions
